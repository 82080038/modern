<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard - Trading Platform Modern</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        .trading-card { border-left: 4px solid #007bff; }
        .order-card { border-left: 4px solid #28a745; }
        .position-card { border-left: 4px solid #ffc107; }
        .risk-card { border-left: 4px solid #dc3545; }
        .mode-indicator { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            z-index: 1000; 
            padding: 5px 10px; 
            border-radius: 5px; 
            font-weight: bold;
        }
        .mode-training { background-color: #28a745; color: white; }
        .mode-realtime { background-color: #dc3545; color: white; }
        .price-up { color: #28a745; }
        .price-down { color: #dc3545; }
        .price-neutral { color: #6c757d; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                üöÄ Trading Platform Modern
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="fundamental.html">Fundamental</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sentiment.html">Sentiment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="trading.html">Trading</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Trading Mode Indicator -->
    <div id="mode-indicator" class="mode-indicator mode-training">
        Training Mode
    </div>

    <div class="container-fluid mt-4">
        <!-- Trading Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card trading-card">
                    <div class="card-header">
                        <h5 class="mb-0">üéØ Trading Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="trading-mode">Trading Mode:</label>
                                    <select class="form-select" id="trading-mode" onchange="switchTradingMode()">
                                        <option value="training">Training Mode</option>
                                        <option value="real_time">Real-Time Trading</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="auto-trading">Auto Trading:</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="auto-trading" onchange="toggleAutoTrading()">
                                        <label class="form-check-label" for="auto-trading">Enable</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="symbol-input">Symbol:</label>
                                    <input type="text" class="form-control" id="symbol-input" placeholder="e.g., BBCA" value="BBCA">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <div class="d-grid">
                                        <button class="btn btn-primary" onclick="loadTradingData()">Refresh Data</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Summary -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card position-card">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Portfolio Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="portfolio-summary">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading portfolio data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card risk-card">
                    <div class="card-header">
                        <h5 class="mb-0">‚ö†Ô∏è Risk Metrics</h5>
                    </div>
                    <div class="card-body">
                        <div id="risk-metrics">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading risk data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Management -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card order-card">
                    <div class="card-header">
                        <h5 class="mb-0">üìã Place Order</h5>
                    </div>
                    <div class="card-body">
                        <form id="order-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="order-symbol" class="form-label">Symbol:</label>
                                        <input type="text" class="form-control" id="order-symbol" placeholder="BBCA" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="order-side" class="form-label">Side:</label>
                                        <select class="form-select" id="order-side" required>
                                            <option value="buy">Buy</option>
                                            <option value="sell">Sell</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="order-type" class="form-label">Order Type:</label>
                                        <select class="form-select" id="order-type" onchange="toggleOrderFields()" required>
                                            <option value="market">Market</option>
                                            <option value="limit">Limit</option>
                                            <option value="stop_loss">Stop Loss</option>
                                            <option value="stop_limit">Stop Limit</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="order-quantity" class="form-label">Quantity:</label>
                                        <input type="number" class="form-control" id="order-quantity" min="1" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="price-fields" style="display: none;">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="order-price" class="form-label">Price:</label>
                                        <input type="number" class="form-control" id="order-price" step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="order-stop-price" class="form-label">Stop Price:</label>
                                        <input type="number" class="form-control" id="order-stop-price" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="order-notes" class="form-label">Notes:</label>
                                <textarea class="form-control" id="order-notes" rows="2"></textarea>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success">Place Order</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìà Current Positions</h5>
                    </div>
                    <div class="card-body">
                        <div id="positions-list">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading positions...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order History & Trade History -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìã Order History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="orders-table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-tbody">
                                    <tr>
                                        <td colspan="7" class="text-center">Loading orders...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üí∞ Trade History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="trades-table">
                                <thead>
                                    <tr>
                                        <th>Trade ID</th>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>P&L</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="trades-tbody">
                                    <tr>
                                        <td colspan="7" class="text-center">Loading trades...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let currentMode = 'training';
        let socket = null;
        
        // Initialize page
        $(document).ready(function() {
            initializeWebSocket();
            loadTradingData();
            setupEventHandlers();
        });
        
        function initializeWebSocket() {
            socket = io('http://localhost:8000');
            
            socket.on('connect', function() {
                console.log('Connected to WebSocket');
            });
            
            socket.on('price_update', function(data) {
                updatePriceDisplay(data);
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from WebSocket');
            });
        }
        
        function setupEventHandlers() {
            // Order form submission
            $('#order-form').on('submit', function(e) {
                e.preventDefault();
                placeOrder();
            });
            
            // Auto-refresh data every 30 seconds
            setInterval(loadTradingData, 30000);
        }
        
        function loadTradingData() {
            loadPortfolioSummary();
            loadRiskMetrics();
            loadPositions();
            loadOrderHistory();
            loadTradeHistory();
        }
        
        function loadPortfolioSummary() {
            $.ajax({
                url: API_BASE + '/trading/portfolio',
                method: 'GET',
                data: { trading_mode: currentMode },
                success: function(data) {
                    updatePortfolioSummary(data);
                },
                error: function(xhr) {
                    console.error('Error loading portfolio:', xhr);
                    $('#portfolio-summary').html('<div class="alert alert-danger">Error loading portfolio data</div>');
                }
            });
        }
        
        function updatePortfolioSummary(data) {
            const html = `
                <div class="row">
                    <div class="col-6">
                        <h6>Total Value</h6>
                        <h4 class="text-primary">Rp ${data.total_value.toLocaleString()}</h4>
                    </div>
                    <div class="col-6">
                        <h6>Total P&L</h6>
                        <h4 class="${data.total_pnl >= 0 ? 'text-success' : 'text-danger'}">
                            Rp ${data.total_pnl.toLocaleString()} (${data.total_pnl_percent.toFixed(2)}%)
                        </h4>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <small class="text-muted">Positions: ${data.total_positions}</small>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Cost Basis: Rp ${data.total_cost.toLocaleString()}</small>
                    </div>
                </div>
            `;
            $('#portfolio-summary').html(html);
        }
        
        function loadRiskMetrics() {
            $.ajax({
                url: API_BASE + '/trading/risk',
                method: 'GET',
                data: { trading_mode: currentMode },
                success: function(data) {
                    updateRiskMetrics(data);
                },
                error: function(xhr) {
                    console.error('Error loading risk metrics:', xhr);
                    $('#risk-metrics').html('<div class="alert alert-danger">Error loading risk data</div>');
                }
            });
        }
        
        function updateRiskMetrics(data) {
            const html = `
                <div class="row">
                    <div class="col-6">
                        <h6>Portfolio Value</h6>
                        <h5>Rp ${data.portfolio_value.toLocaleString()}</h5>
                    </div>
                    <div class="col-6">
                        <h6>1-Day VaR</h6>
                        <h5 class="text-warning">Rp ${data.var_1d.toLocaleString()}</h5>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <small class="text-muted">Total P&L: Rp ${data.total_pnl.toLocaleString()}</small>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Positions: ${data.position_count}</small>
                    </div>
                </div>
            `;
            $('#risk-metrics').html(html);
        }
        
        function loadPositions() {
            $.ajax({
                url: API_BASE + '/trading/positions',
                method: 'GET',
                data: { trading_mode: currentMode },
                success: function(data) {
                    updatePositions(data.positions);
                },
                error: function(xhr) {
                    console.error('Error loading positions:', xhr);
                    $('#positions-list').html('<div class="alert alert-danger">Error loading positions</div>');
                }
            });
        }
        
        function updatePositions(positions) {
            if (positions.length === 0) {
                $('#positions-list').html('<div class="text-center text-muted">No positions</div>');
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Symbol</th><th>Qty</th><th>Avg Price</th><th>Current</th><th>P&L</th></tr></thead><tbody>';
            
            positions.forEach(pos => {
                const pnlClass = pos.total_pnl >= 0 ? 'text-success' : 'text-danger';
                html += `
                    <tr>
                        <td><strong>${pos.symbol}</strong></td>
                        <td>${pos.quantity}</td>
                        <td>Rp ${pos.average_price.toLocaleString()}</td>
                        <td>Rp ${pos.current_price.toLocaleString()}</td>
                        <td class="${pnlClass}">Rp ${pos.total_pnl.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            $('#positions-list').html(html);
        }
        
        function loadOrderHistory() {
            $.ajax({
                url: API_BASE + '/trading/orders',
                method: 'GET',
                data: { trading_mode: currentMode, limit: 20 },
                success: function(data) {
                    updateOrderHistory(data);
                },
                error: function(xhr) {
                    console.error('Error loading orders:', xhr);
                }
            });
        }
        
        function updateOrderHistory(orders) {
            let html = '';
            orders.forEach(order => {
                const statusClass = getStatusClass(order.status);
                html += `
                    <tr>
                        <td><small>${order.order_id.substring(0, 12)}...</small></td>
                        <td>${order.symbol}</td>
                        <td><span class="badge ${order.side === 'buy' ? 'bg-success' : 'bg-danger'}">${order.side.toUpperCase()}</span></td>
                        <td>${order.quantity}</td>
                        <td>${order.price ? 'Rp ' + order.price.toLocaleString() : 'Market'}</td>
                        <td><span class="badge ${statusClass}">${order.status.toUpperCase()}</span></td>
                        <td>
                            ${order.status === 'pending' ? '<button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(\'' + order.order_id + '\')">Cancel</button>' : ''}
                        </td>
                    </tr>
                `;
            });
            $('#orders-tbody').html(html);
        }
        
        function loadTradeHistory() {
            $.ajax({
                url: API_BASE + '/trading/trades',
                method: 'GET',
                data: { trading_mode: currentMode, limit: 20 },
                success: function(data) {
                    updateTradeHistory(data.trades);
                },
                error: function(xhr) {
                    console.error('Error loading trades:', xhr);
                }
            });
        }
        
        function updateTradeHistory(trades) {
            let html = '';
            trades.forEach(trade => {
                const pnlClass = trade.realized_pnl >= 0 ? 'text-success' : 'text-danger';
                html += `
                    <tr>
                        <td><small>${trade.trade_id.substring(0, 12)}...</small></td>
                        <td>${trade.symbol}</td>
                        <td><span class="badge ${trade.side === 'buy' ? 'bg-success' : 'bg-danger'}">${trade.side.toUpperCase()}</span></td>
                        <td>${trade.quantity}</td>
                        <td>Rp ${trade.price.toLocaleString()}</td>
                        <td class="${pnlClass}">Rp ${trade.realized_pnl ? trade.realized_pnl.toLocaleString() : '0'}</td>
                        <td><small>${new Date(trade.executed_at).toLocaleString()}</small></td>
                    </tr>
                `;
            });
            $('#trades-tbody').html(html);
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'filled': return 'bg-success';
                case 'pending': return 'bg-warning';
                case 'cancelled': return 'bg-secondary';
                case 'rejected': return 'bg-danger';
                default: return 'bg-info';
            }
        }
        
        function placeOrder() {
            const orderData = {
                symbol: $('#order-symbol').val().toUpperCase(),
                order_type: $('#order-type').val(),
                side: $('#order-side').val(),
                quantity: parseInt($('#order-quantity').val()),
                price: $('#order-price').val() ? parseFloat($('#order-price').val()) : null,
                stop_price: $('#order-stop-price').val() ? parseFloat($('#order-stop-price').val()) : null,
                trading_mode: currentMode,
                auto_trading: $('#auto-trading').is(':checked'),
                notes: $('#order-notes').val()
            };
            
            $.ajax({
                url: API_BASE + '/trading/orders',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(orderData),
                success: function(data) {
                    alert('Order placed successfully! Order ID: ' + data.order_id);
                    $('#order-form')[0].reset();
                    loadTradingData();
                },
                error: function(xhr) {
                    alert('Error placing order: ' + xhr.responseText);
                }
            });
        }
        
        function cancelOrder(orderId) {
            if (confirm('Are you sure you want to cancel this order?')) {
                $.ajax({
                    url: API_BASE + '/trading/orders/' + orderId,
                    method: 'DELETE',
                    success: function(data) {
                        alert('Order cancelled successfully!');
                        loadTradingData();
                    },
                    error: function(xhr) {
                        alert('Error cancelling order: ' + xhr.responseText);
                    }
                });
            }
        }
        
        function switchTradingMode() {
            const newMode = $('#trading-mode').val();
            
            $.ajax({
                url: API_BASE + '/trading/mode/switch',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(newMode),
                success: function(data) {
                    currentMode = newMode;
                    updateModeIndicator();
                    loadTradingData();
                    alert('Switched to ' + newMode + ' mode');
                },
                error: function(xhr) {
                    alert('Error switching mode: ' + xhr.responseText);
                }
            });
        }
        
        function toggleAutoTrading() {
            // This would be implemented based on the current mode
            console.log('Auto trading toggled:', $('#auto-trading').is(':checked'));
        }
        
        function updateModeIndicator() {
            const indicator = $('#mode-indicator');
            if (currentMode === 'training') {
                indicator.removeClass('mode-realtime').addClass('mode-training').text('Training Mode');
            } else {
                indicator.removeClass('mode-training').addClass('mode-realtime').text('Real-Time Mode');
            }
        }
        
        function toggleOrderFields() {
            const orderType = $('#order-type').val();
            const priceFields = $('#price-fields');
            
            if (orderType === 'market') {
                priceFields.hide();
            } else {
                priceFields.show();
            }
        }
        
        function updatePriceDisplay(data) {
            // Update price displays in real-time
            console.log('Price update:', data);
        }
    </script>
</body>
</html>
