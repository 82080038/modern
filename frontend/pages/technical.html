<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Analysis - Trading Platform Modern</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .indicator-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .signal-card {
            border-left: 4px solid #28a745;
            background: #f8f9fa;
        }
        .signal-buy {
            border-left-color: #28a745;
        }
        .signal-sell {
            border-left-color: #dc3545;
        }
        .signal-hold {
            border-left-color: #ffc107;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .trend-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .trend-bullish {
            background: #d4edda;
            color: #155724;
        }
        .trend-bearish {
            background: #f8d7da;
            color: #721c24;
        }
        .trend-neutral {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-chart-line me-2"></i>Trading Platform Modern
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="fundamental.html">Fundamental</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="technical.html">Technical</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sentiment.html">Sentiment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="trading.html">Trading</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-chart-line me-2"></i>Technical Analysis</h2>
                <p class="text-muted">Advanced technical indicators and AI-powered pattern recognition</p>
            </div>
        </div>

        <!-- Symbol Selection -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="symbolInput" placeholder="Enter symbol (e.g., BBCA.JK)" value="BBCA.JK">
                    <button class="btn btn-primary" onclick="loadTechnicalData()">
                        <i class="fas fa-chart-bar me-1"></i>Analyze
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary active" onclick="setTimeframe('1D')">1D</button>
                    <button class="btn btn-outline-primary" onclick="setTimeframe('1W')">1W</button>
                    <button class="btn btn-outline-primary" onclick="setTimeframe('1M')">1M</button>
                    <button class="btn btn-outline-primary" onclick="setTimeframe('3M')">3M</button>
                </div>
            </div>
        </div>

        <!-- Technical Summary -->
        <div class="row mb-4" id="technicalSummary" style="display: none;">
            <div class="col-md-3">
                <div class="card signal-card">
                    <div class="card-body">
                        <h6 class="card-title">Recommendation</h6>
                        <div class="metric-value" id="recommendation">-</div>
                        <small class="text-muted">Confidence: <span id="confidence">-</span></small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Trend</h6>
                        <div class="trend-indicator" id="trendIndicator">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Momentum</h6>
                        <div id="momentum">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">AI Score</h6>
                        <div class="metric-value" id="aiScore">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Indicators -->
        <div class="row">
            <!-- Price Chart -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-candlestick me-2"></i>Price Chart</h5>
                    </div>
                    <div class="card-body">
                        <div id="priceChart" class="chart-container"></div>
                    </div>
                </div>
            </div>

            <!-- Technical Indicators -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i>Technical Indicators</h5>
                    </div>
                    <div class="card-body">
                        <div id="indicatorsList">
                            <div class="text-center text-muted">
                                <i class="fas fa-chart-line fa-3x mb-3"></i>
                                <p>Select a symbol to view technical indicators</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Indicators -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>Detailed Technical Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="detailedIndicators">
                            <!-- Indicators will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-robot me-2"></i>AI-Powered Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="aiAnalysis">
                            <!-- AI analysis will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let chart = null;
        let currentSymbol = 'BBCA.JK';

        // Initialize chart
        function initChart() {
            const chartContainer = document.getElementById('priceChart');
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 400,
                layout: {
                    backgroundColor: '#ffffff',
                    textColor: '#333',
                },
                grid: {
                    vertLines: {
                        color: '#f0f0f0',
                    },
                    horzLines: {
                        color: '#f0f0f0',
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#cccccc',
                },
                timeScale: {
                    borderColor: '#cccccc',
                },
            });
        }

        // Load technical data
        async function loadTechnicalData() {
            const symbol = document.getElementById('symbolInput').value.trim();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            currentSymbol = symbol;
            showLoading();

            try {
                // Load technical summary
                const summaryResponse = await fetch(`/api/v1/technical/summary/${symbol}`);
                if (summaryResponse.ok) {
                    const summary = await summaryResponse.json();
                    displayTechnicalSummary(summary);
                }

                // Load technical indicators
                const indicatorsResponse = await fetch(`/api/v1/technical/indicators/${symbol}?limit=1`);
                if (indicatorsResponse.ok) {
                    const indicators = await indicatorsResponse.json();
                    displayTechnicalIndicators(indicators);
                }

                // Load AI analysis
                const aiResponse = await fetch(`/api/v1/ai-ml/pattern-analysis/${symbol}?limit=1`);
                if (aiResponse.ok) {
                    const aiData = await aiResponse.json();
                    displayAIAnalysis(aiData);
                }

                document.getElementById('technicalSummary').style.display = 'block';
            } catch (error) {
                console.error('Error loading technical data:', error);
                alert('Error loading technical data. Please try again.');
            }
        }

        // Display technical summary
        function displayTechnicalSummary(data) {
            document.getElementById('recommendation').textContent = data.recommendation;
            document.getElementById('confidence').textContent = (data.confidence * 100).toFixed(1) + '%';
            document.getElementById('trendIndicator').textContent = data.trend;
            document.getElementById('trendIndicator').className = `trend-indicator trend-${data.trend.toLowerCase()}`;
            document.getElementById('momentum').textContent = data.momentum;
            document.getElementById('aiScore').textContent = (data.ai_score * 100).toFixed(1) + '%';
        }

        // Display technical indicators
        function displayTechnicalIndicators(data) {
            const indicatorsList = document.getElementById('indicatorsList');
            const detailedIndicators = document.getElementById('detailedIndicators');
            
            if (data.indicators && data.indicators.length > 0) {
                const indicator = data.indicators[0];
                
                // Basic indicators
                indicatorsList.innerHTML = `
                    <div class="row">
                        <div class="col-6">
                            <div class="indicator-card">
                                <h6>RSI</h6>
                                <div class="metric-value">${indicator.rsi ? indicator.rsi.toFixed(2) : 'N/A'}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="indicator-card">
                                <h6>MACD</h6>
                                <div class="metric-value">${indicator.macd ? indicator.macd.toFixed(4) : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="indicator-card">
                                <h6>SMA 20</h6>
                                <div class="metric-value">${indicator.sma_20 ? indicator.sma_20.toFixed(2) : 'N/A'}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="indicator-card">
                                <h6>SMA 50</h6>
                                <div class="metric-value">${indicator.sma_50 ? indicator.sma_50.toFixed(2) : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Detailed indicators
                detailedIndicators.innerHTML = `
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>Bollinger Bands</h6>
                                <p><strong>Upper:</strong> ${indicator.bollinger_upper ? indicator.bollinger_upper.toFixed(2) : 'N/A'}</p>
                                <p><strong>Middle:</strong> ${indicator.bollinger_middle ? indicator.bollinger_middle.toFixed(2) : 'N/A'}</p>
                                <p><strong>Lower:</strong> ${indicator.bollinger_lower ? indicator.bollinger_lower.toFixed(2) : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>Stochastic</h6>
                                <p><strong>%K:</strong> ${indicator.stochastic_k ? indicator.stochastic_k.toFixed(2) : 'N/A'}</p>
                                <p><strong>%D:</strong> ${indicator.stochastic_d ? indicator.stochastic_d.toFixed(2) : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>Williams %R</h6>
                                <p><strong>Value:</strong> ${indicator.williams_r ? indicator.williams_r.toFixed(2) : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>CCI</h6>
                                <p><strong>Value:</strong> ${indicator.cci ? indicator.cci.toFixed(2) : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Display AI analysis
        function displayAIAnalysis(data) {
            const aiAnalysis = document.getElementById('aiAnalysis');
            
            if (data.analyses && data.analyses.length > 0) {
                const analysis = data.analyses[0];
                
                aiAnalysis.innerHTML = `
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6>Pattern Strength</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar" style="width: ${(analysis.pattern_strength * 100).toFixed(1)}%"></div>
                                </div>
                                <small>${(analysis.pattern_strength * 100).toFixed(1)}%</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6>Gap Accuracy</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-success" style="width: ${(analysis.gap_accuracy * 100).toFixed(1)}%"></div>
                                </div>
                                <small>${(analysis.gap_accuracy * 100).toFixed(1)}%</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6>Overall Effectiveness</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-info" style="width: ${(analysis.overall_effectiveness * 100).toFixed(1)}%"></div>
                                </div>
                                <small>${(analysis.overall_effectiveness * 100).toFixed(1)}%</small>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Set timeframe
        function setTimeframe(timeframe) {
            // Remove active class from all buttons
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Reload data with new timeframe
            loadTechnicalData();
        }

        // Show loading state
        function showLoading() {
            document.getElementById('technicalSummary').style.display = 'none';
            document.getElementById('indicatorsList').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading technical analysis...</p>
                </div>
            `;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            loadTechnicalData();
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('priceChart').clientWidth,
                });
            }
        });
    </script>
</body>
</html>