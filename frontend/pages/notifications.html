<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Trading Platform Modern</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        .notification-card { 
            border-left: 4px solid #007bff; 
            margin-bottom: 10px;
        }
        .notification-unread { 
            background-color: #f8f9fa; 
            border-left-color: #dc3545;
        }
        .notification-read { 
            background-color: #ffffff; 
            opacity: 0.8;
        }
        .notification-archived { 
            background-color: #e9ecef; 
            opacity: 0.6;
        }
        .notification-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .filter-buttons {
            margin-bottom: 20px;
        }
        .filter-btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                üöÄ Trading Platform Modern
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="fundamental.html">Fundamental</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sentiment.html">Sentiment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="trading.html">Trading</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="notifications.html">Notifications</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Notification Badge -->
    <div id="notification-badge" class="notification-badge" style="display: none;">
        <span id="unread-count">0</span>
    </div>

    <div class="container-fluid mt-4">
        <!-- Notification Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üîî Notification Center</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="filter-buttons">
                                    <button class="btn btn-outline-primary filter-btn active" onclick="filterNotifications('all')">All</button>
                                    <button class="btn btn-outline-primary filter-btn" onclick="filterNotifications('unread')">Unread</button>
                                    <button class="btn btn-outline-primary filter-btn" onclick="filterNotifications('read')">Read</button>
                                    <button class="btn btn-outline-primary filter-btn" onclick="filterNotifications('archived')">Archived</button>
                                </div>
                                <div class="filter-buttons">
                                    <button class="btn btn-outline-secondary filter-btn" onclick="filterByType('order_filled')">Orders</button>
                                    <button class="btn btn-outline-secondary filter-btn" onclick="filterByType('price_alert')">Price Alerts</button>
                                    <button class="btn btn-outline-secondary filter-btn" onclick="filterByType('sentiment_alert')">Sentiment</button>
                                    <button class="btn btn-outline-secondary filter-btn" onclick="filterByType('risk_alert')">Risk</button>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-success" onclick="markAllAsRead()">Mark All Read</button>
                                <button class="btn btn-warning" onclick="cleanupNotifications()">Cleanup</button>
                                <button class="btn btn-primary" onclick="loadNotifications()">Refresh</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary" id="total-notifications">0</h5>
                        <p class="card-text">Total Notifications</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-danger" id="unread-notifications">0</h5>
                        <p class="card-text">Unread</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success" id="read-notifications">0</h5>
                        <p class="card-text">Read</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-secondary" id="archived-notifications">0</h5>
                        <p class="card-text">Archived</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìã Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div id="notifications-list">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading notifications...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Rules Management -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">‚öôÔ∏è Alert Rules</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Create New Alert Rule</h6>
                                <form id="alert-rule-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="rule-name" class="form-label">Rule Name:</label>
                                                <input type="text" class="form-control" id="rule-name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="rule-symbol" class="form-label">Symbol:</label>
                                                <input type="text" class="form-control" id="rule-symbol" placeholder="BBCA" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="rule-type" class="form-label">Alert Type:</label>
                                                <select class="form-select" id="rule-type" required>
                                                    <option value="price">Price</option>
                                                    <option value="volume">Volume</option>
                                                    <option value="sentiment">Sentiment</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="rule-condition" class="form-label">Condition:</label>
                                                <select class="form-select" id="rule-condition" required>
                                                    <option value="above">Above</option>
                                                    <option value="below">Below</option>
                                                    <option value="equals">Equals</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="rule-threshold" class="form-label">Threshold:</label>
                                                <input type="number" class="form-control" id="rule-threshold" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="rule-priority" class="form-label">Priority:</label>
                                                <select class="form-select" id="rule-priority">
                                                    <option value="low">Low</option>
                                                    <option value="medium" selected>Medium</option>
                                                    <option value="high">High</option>
                                                    <option value="critical">Critical</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="rule-cooldown" class="form-label">Cooldown (minutes):</label>
                                                <input type="number" class="form-control" id="rule-cooldown" value="60" min="1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="rule-description" class="form-label">Description:</label>
                                        <textarea class="form-control" id="rule-description" rows="2"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Create Alert Rule</button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <h6>Active Alert Rules</h6>
                                <div id="alert-rules-list">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading alert rules...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let currentFilter = 'all';
        let currentTypeFilter = null;
        let socket = null;
        
        // Initialize page
        $(document).ready(function() {
            initializeWebSocket();
            loadNotifications();
            loadNotificationStats();
            loadAlertRules();
            setupEventHandlers();
            
            // Auto-refresh every 30 seconds
            setInterval(function() {
                loadNotifications();
                loadNotificationStats();
            }, 30000);
        });
        
        function initializeWebSocket() {
            socket = io('http://localhost:8000');
            
            socket.on('connect', function() {
                console.log('Connected to WebSocket');
            });
            
            socket.on('notification', function(data) {
                // Handle real-time notification
                showNotificationToast(data);
                loadNotifications();
                loadNotificationStats();
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from WebSocket');
            });
        }
        
        function setupEventHandlers() {
            // Alert rule form submission
            $('#alert-rule-form').on('submit', function(e) {
                e.preventDefault();
                createAlertRule();
            });
        }
        
        function loadNotifications() {
            let url = API_BASE + '/notifications/';
            let params = new URLSearchParams();
            
            if (currentFilter !== 'all') {
                params.append('status', currentFilter);
            }
            
            if (currentTypeFilter) {
                params.append('type', currentTypeFilter);
            }
            
            params.append('limit', 100);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            $.ajax({
                url: url,
                method: 'GET',
                success: function(data) {
                    updateNotificationsList(data);
                },
                error: function(xhr) {
                    console.error('Error loading notifications:', xhr);
                    $('#notifications-list').html('<div class="alert alert-danger">Error loading notifications</div>');
                }
            });
        }
        
        function updateNotificationsList(notifications) {
            if (notifications.length === 0) {
                $('#notifications-list').html('<div class="text-center text-muted">No notifications found</div>');
                return;
            }
            
            let html = '';
            notifications.forEach(notif => {
                const statusClass = getStatusClass(notif.status);
                const priorityClass = getPriorityClass(notif.priority);
                const timeAgo = getTimeAgo(notif.created_at);
                
                html += `
                    <div class="card notification-card ${statusClass}" data-notification-id="${notif.id}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-1">
                                    <span class="notification-icon">${notif.icon}</span>
                                </div>
                                <div class="col-md-8">
                                    <h6 class="card-title">${notif.title}</h6>
                                    <p class="card-text">${notif.message}</p>
                                    <small class="text-muted">
                                        ${notif.symbol ? 'Symbol: ' + notif.symbol + ' ‚Ä¢ ' : ''}
                                        ${timeAgo}
                                        ${notif.status === 'unread' ? ' ‚Ä¢ <span class="badge bg-danger">Unread</span>' : ''}
                                    </small>
                                </div>
                                <div class="col-md-3 text-end">
                                    <div class="btn-group-vertical" role="group">
                                        ${notif.status === 'unread' ? '<button class="btn btn-sm btn-success" onclick="markAsRead(\'' + notif.id + '\')">Mark Read</button>' : ''}
                                        ${notif.status !== 'archived' ? '<button class="btn btn-sm btn-warning" onclick="archiveNotification(\'' + notif.id + '\')">Archive</button>' : ''}
                                        ${notif.action_url ? '<a href="' + notif.action_url + '" class="btn btn-sm btn-primary">' + (notif.action_text || 'View') + '</a>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#notifications-list').html(html);
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'unread': return 'notification-unread';
                case 'read': return 'notification-read';
                case 'archived': return 'notification-archived';
                default: return '';
            }
        }
        
        function getPriorityClass(priority) {
            switch(priority) {
                case 'critical': return 'border-danger';
                case 'high': return 'border-warning';
                case 'medium': return 'border-primary';
                case 'low': return 'border-secondary';
                default: return 'border-primary';
            }
        }
        
        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return diffMins + ' minutes ago';
            if (diffHours < 24) return diffHours + ' hours ago';
            if (diffDays < 7) return diffDays + ' days ago';
            return time.toLocaleDateString();
        }
        
        function loadNotificationStats() {
            $.ajax({
                url: API_BASE + '/notifications/stats',
                method: 'GET',
                success: function(data) {
                    updateNotificationStats(data);
                },
                error: function(xhr) {
                    console.error('Error loading notification stats:', xhr);
                }
            });
        }
        
        function updateNotificationStats(stats) {
            $('#total-notifications').text(stats.total_notifications);
            $('#unread-notifications').text(stats.unread_count);
            $('#read-notifications').text(stats.read_count);
            $('#archived-notifications').text(stats.archived_count);
            
            // Update badge
            if (stats.unread_count > 0) {
                $('#notification-badge').show();
                $('#unread-count').text(stats.unread_count);
            } else {
                $('#notification-badge').hide();
            }
        }
        
        function loadAlertRules() {
            $.ajax({
                url: API_BASE + '/notifications/alert-rules',
                method: 'GET',
                success: function(data) {
                    updateAlertRulesList(data.rules);
                },
                error: function(xhr) {
                    console.error('Error loading alert rules:', xhr);
                    $('#alert-rules-list').html('<div class="alert alert-danger">Error loading alert rules</div>');
                }
            });
        }
        
        function updateAlertRulesList(rules) {
            if (rules.length === 0) {
                $('#alert-rules-list').html('<div class="text-center text-muted">No alert rules</div>');
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Name</th><th>Symbol</th><th>Type</th><th>Condition</th><th>Threshold</th><th>Priority</th><th>Triggers</th><th>Status</th></tr></thead><tbody>';
            
            rules.forEach(rule => {
                const statusBadge = rule.is_active ? 'bg-success' : 'bg-secondary';
                const priorityBadge = getPriorityBadge(rule.priority);
                
                html += `
                    <tr>
                        <td><strong>${rule.name}</strong></td>
                        <td>${rule.symbol}</td>
                        <td>${rule.alert_type}</td>
                        <td>${rule.condition}</td>
                        <td>${rule.threshold_value}</td>
                        <td><span class="badge ${priorityBadge}">${rule.priority}</span></td>
                        <td>${rule.trigger_count}</td>
                        <td><span class="badge ${statusBadge}">${rule.is_active ? 'Active' : 'Inactive'}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            $('#alert-rules-list').html(html);
        }
        
        function getPriorityBadge(priority) {
            switch(priority) {
                case 'critical': return 'bg-danger';
                case 'high': return 'bg-warning';
                case 'medium': return 'bg-primary';
                case 'low': return 'bg-secondary';
                default: return 'bg-primary';
            }
        }
        
        function filterNotifications(status) {
            currentFilter = status;
            currentTypeFilter = null;
            
            // Update filter buttons
            $('.filter-btn').removeClass('active');
            event.target.classList.add('active');
            
            loadNotifications();
        }
        
        function filterByType(type) {
            currentTypeFilter = type;
            currentFilter = 'all';
            
            // Update filter buttons
            $('.filter-btn').removeClass('active');
            event.target.classList.add('active');
            
            loadNotifications();
        }
        
        function markAsRead(notificationId) {
            $.ajax({
                url: API_BASE + '/notifications/' + notificationId + '/read',
                method: 'PUT',
                success: function(data) {
                    loadNotifications();
                    loadNotificationStats();
                },
                error: function(xhr) {
                    alert('Error marking notification as read: ' + xhr.responseText);
                }
            });
        }
        
        function markAllAsRead() {
            if (confirm('Are you sure you want to mark all notifications as read?')) {
                $.ajax({
                    url: API_BASE + '/notifications/read-all',
                    method: 'PUT',
                    success: function(data) {
                        alert('Marked ' + data.updated_count + ' notifications as read');
                        loadNotifications();
                        loadNotificationStats();
                    },
                    error: function(xhr) {
                        alert('Error marking all notifications as read: ' + xhr.responseText);
                    }
                });
            }
        }
        
        function archiveNotification(notificationId) {
            $.ajax({
                url: API_BASE + '/notifications/' + notificationId + '/archive',
                method: 'PUT',
                success: function(data) {
                    loadNotifications();
                    loadNotificationStats();
                },
                error: function(xhr) {
                    alert('Error archiving notification: ' + xhr.responseText);
                }
            });
        }
        
        function cleanupNotifications() {
            if (confirm('Are you sure you want to cleanup expired and old notifications?')) {
                $.ajax({
                    url: API_BASE + '/notifications/cleanup',
                    method: 'POST',
                    success: function(data) {
                        alert('Cleanup completed: ' + data.message);
                        loadNotifications();
                        loadNotificationStats();
                    },
                    error: function(xhr) {
                        alert('Error cleaning up notifications: ' + xhr.responseText);
                    }
                });
            }
        }
        
        function createAlertRule() {
            const ruleData = {
                name: $('#rule-name').val(),
                description: $('#rule-description').val(),
                symbol: $('#rule-symbol').val().toUpperCase(),
                alert_type: $('#rule-type').val(),
                condition: $('#rule-condition').val(),
                threshold_value: parseFloat($('#rule-threshold').val()),
                notification_type: 'price_alert',
                priority: $('#rule-priority').val(),
                cooldown_minutes: parseInt($('#rule-cooldown').val())
            };
            
            $.ajax({
                url: API_BASE + '/notifications/alert-rules',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(ruleData),
                success: function(data) {
                    alert('Alert rule created successfully!');
                    $('#alert-rule-form')[0].reset();
                    loadAlertRules();
                },
                error: function(xhr) {
                    alert('Error creating alert rule: ' + xhr.responseText);
                }
            });
        }
        
        function showNotificationToast(notification) {
            // Create toast notification
            const toastHtml = `
                <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <span class="notification-icon me-2">${notification.icon}</span>
                        <strong class="me-auto">${notification.title}</strong>
                        <small class="text-muted">just now</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${notification.message}
                    </div>
                </div>
            `;
            
            // Add to toast container
            if (!$('#toast-container').length) {
                $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
            }
            
            $('#toast-container').append(toastHtml);
            
            // Show toast
            const toastElement = $('#toast-container .toast').last()[0];
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toastElement.remove();
            }, 5000);
        }
    </script>
</body>
</html>
